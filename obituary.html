document.addEventListener('DOMContentLoaded', function() {
    const mainPhotoElement = document.getElementById('obituary-photo');
    const obituaryTextElement = document.getElementById('obituary-text');
    const carousel = document.querySelector('.carousel');
    const mapContainer = document.getElementById('map-container');
    const messagesContainer = document.getElementById('messages-container');
    const messageForm = document.getElementById('message-form');
    const flowerOrderLink = document.getElementById('flower-order-link');

    // 从 localStorage 获取数据
    const photoUrl = localStorage.getItem('photoUrl');
    const obituaryData = JSON.parse(localStorage.getItem('obituaryData')) || {};
    const musicUrl = localStorage.getItem('musicUrl') || '';

    // 设置主要照片
    if (photoUrl) {
        mainPhotoElement.src = photoUrl;
    }

    // 填充訃闻信息
    if (obituaryData) {
        document.getElementById('name').textContent = obituaryData.name || '';
        document.getElementById('birth-date').textContent = obituaryData.birthDate || '';
        document.getElementById('death-date').textContent = obituaryData.deathDate || '';
        document.getElementById('age').textContent = obituaryData.age || '';
        document.getElementById('funeral-space').textContent = obituaryData.funeralSpace || '';
        document.getElementById('family-service-time').textContent = obituaryData.familyServiceTime || '';
        document.getElementById('public-service-time').textContent = obituaryData.publicServiceTime || '';
        document.getElementById('funeral-location').textContent = obituaryData.funeralLocation || '';
    }

    // 处理幻灯片图片
    const imageUrls = JSON.parse(localStorage.getItem('photoUrls')) || [];
    imageUrls.forEach(url => {
        const img = document.createElement('div');
        img.classList.add('carousel-item');
        img.innerHTML = `<img src="${url}" alt="追思照片">`;
        carousel.appendChild(img);
    });

    // 初始化 Slick Carousel
    $(carousel).slick({
        dots: true,
        infinite: true,
        speed: 500,
        slidesToShow: 1,
        adaptiveHeight: true
    });

    // 设置地图
    if (obituaryData.mapLocation) {
        const map = new google.maps.Map(mapContainer, {
            center: { lat: obituaryData.mapLocation.lat, lng: obituaryData.mapLocation.lng },
            zoom: 15
        });
        new google.maps.Marker({
            position: { lat: obituaryData.mapLocation.lat, lng: obituaryData.mapLocation.lng },
            map: map
        });
    }

    // 处理留言
    messageForm.addEventListener('submit', function(event) {
        event.preventDefault();

        const name = document.getElementById('message-name').value;
        const content = document.getElementById('message-content').value;

        const messageElement = document.createElement('div');
        messageElement.classList.add('message');
        messageElement.innerHTML = `<strong>${name}</strong>: ${content}`;
        messagesContainer.appendChild(messageElement);

        // 清空表单
        messageForm.reset();
    });

    // 音乐控制
    document.getElementById('music-toggle').addEventListener('click', function() {
        const backgroundMusic = document.getElementById('background-music');
        if (backgroundMusic.paused) {
            backgroundMusic.play();
            this.textContent = "🔈";
        } else {
            backgroundMusic.pause();
            this.textContent = "🔊";
        }
    });

    // 跳转到花篮订购页面
    if (flowerOrderLink) {
        flowerOrderLink.addEventListener('click', function() {
            window.location.href = 'flower-order.html';
        });
    }
});
