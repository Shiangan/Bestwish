document.addEventListener('DOMContentLoaded', function() {
    const mainPhotoElement = document.getElementById('obituary-photo');
    const obituaryTextElement = document.getElementById('obituary-text');
    const carousel = document.querySelector('.carousel');
    const mapContainer = document.getElementById('map-container');
    const messagesContainer = document.getElementById('messages-container');
    const messageForm = document.getElementById('message-form');
    const flowerOrderLink = document.getElementById('flower-order-link');

    // ä» localStorage è·å–æ•°æ®
    const photoUrl = localStorage.getItem('photoUrl');
    const obituaryData = JSON.parse(localStorage.getItem('obituaryData')) || {};
    const musicUrl = localStorage.getItem('musicUrl') || '';

    // è®¾ç½®ä¸»è¦ç…§ç‰‡
    if (photoUrl) {
        mainPhotoElement.src = photoUrl;
    }

    // å¡«å……è¨ƒé—»ä¿¡æ¯
    if (obituaryData) {
        document.getElementById('name').textContent = obituaryData.name || '';
        document.getElementById('birth-date').textContent = obituaryData.birthDate || '';
        document.getElementById('death-date').textContent = obituaryData.deathDate || '';
        document.getElementById('age').textContent = obituaryData.age || '';
        document.getElementById('funeral-space').textContent = obituaryData.funeralSpace || '';
        document.getElementById('family-service-time').textContent = obituaryData.familyServiceTime || '';
        document.getElementById('public-service-time').textContent = obituaryData.publicServiceTime || '';
        document.getElementById('funeral-location').textContent = obituaryData.funeralLocation || '';
    }

    // å¤„ç†å¹»ç¯ç‰‡å›¾ç‰‡
    const imageUrls = JSON.parse(localStorage.getItem('photoUrls')) || [];
    imageUrls.forEach(url => {
        const img = document.createElement('div');
        img.classList.add('carousel-item');
        img.innerHTML = `<img src="${url}" alt="è¿½æ€ç…§ç‰‡">`;
        carousel.appendChild(img);
    });

    // åˆå§‹åŒ– Slick Carousel
    $(carousel).slick({
        dots: true,
        infinite: true,
        speed: 500,
        slidesToShow: 1,
        adaptiveHeight: true
    });

    // è®¾ç½®åœ°å›¾
    if (obituaryData.mapLocation) {
        const map = new google.maps.Map(mapContainer, {
            center: { lat: obituaryData.mapLocation.lat, lng: obituaryData.mapLocation.lng },
            zoom: 15
        });
        new google.maps.Marker({
            position: { lat: obituaryData.mapLocation.lat, lng: obituaryData.mapLocation.lng },
            map: map
        });
    }

    // å¤„ç†ç•™è¨€
    messageForm.addEventListener('submit', function(event) {
        event.preventDefault();

        const name = document.getElementById('message-name').value;
        const content = document.getElementById('message-content').value;

        const messageElement = document.createElement('div');
        messageElement.classList.add('message');
        messageElement.innerHTML = `<strong>${name}</strong>: ${content}`;
        messagesContainer.appendChild(messageElement);

        // æ¸…ç©ºè¡¨å•
        messageForm.reset();
    });

    // éŸ³ä¹æ§åˆ¶
    document.getElementById('music-toggle').addEventListener('click', function() {
        const backgroundMusic = document.getElementById('background-music');
        if (backgroundMusic.paused) {
            backgroundMusic.play();
            this.textContent = "ğŸ”ˆ";
        } else {
            backgroundMusic.pause();
            this.textContent = "ğŸ”Š";
        }
    });

    // è·³è½¬åˆ°èŠ±ç¯®è®¢è´­é¡µé¢
    if (flowerOrderLink) {
        flowerOrderLink.addEventListener('click', function() {
            window.location.href = 'flower-order.html';
        });
    }
});
